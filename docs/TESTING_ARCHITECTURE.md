# Dagster Testing Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                     DAGSTER PIPELINE TESTING                        │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    TEST PYRAMID                               │  │
│  │                                                               │  │
│  │                        /\                                     │  │
│  │                       /  \     E2E Tests                      │  │
│  │                      /    \    (Manual/Future)                │  │
│  │                     /------\                                  │  │
│  │                    /        \  Integration Tests              │  │
│  │                   /          \ (test_integration.py)          │  │
│  │                  /------------\                               │  │
│  │                 /              \ Unit Tests                   │  │
│  │                /                \ (test_assets.py,            │  │
│  │               /                  \ test_resources.py,         │  │
│  │              /____________________\ test_sensors.py)          │  │
│  │                                                               │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    TEST ORGANIZATION                          │  │
│  │                                                               │  │
│  │  tests/                                                       │  │
│  │  ├── conftest.py ─────────┐                                  │  │
│  │  │   ├── Fixtures         │                                  │  │
│  │  │   ├── Mock Resources   │                                  │  │
│  │  │   └── Sample Data      │                                  │  │
│  │  │                        │                                  │  │
│  │  ├── test_assets.py ◄─────┤                                  │  │
│  │  │   ├── Extraction       │                                  │  │
│  │  │   ├── Transformation   │                                  │  │
│  │  │   └── Loading          │                                  │  │
│  │  │                        │                                  │  │
│  │  ├── test_resources.py ◄──┤                                  │  │
│  │  │   ├── Google Drive     │                                  │  │
│  │  │   ├── DuckDB           │                                  │  │
│  │  │   ├── PostgreSQL       │                                  │  │
│  │  │   └── MongoDB          │                                  │  │
│  │  │                        │                                  │  │
│  │  ├── test_sensors.py ◄────┤                                  │  │
│  │  │   └── Google Drive     │                                  │  │
│  │  │       Sensor           │                                  │  │
│  │  │                        │                                  │  │
│  │  ├── test_integration.py ◄┤                                  │  │
│  │  │   ├── Definitions      │                                  │  │
│  │  │   ├── Asset Graph      │                                  │  │
│  │  │   └── E2E Flow         │                                  │  │
│  │  │                        │                                  │  │
│  │  └── test_utils.py ───────┘                                  │  │
│  │      ├── Helpers                                             │  │
│  │      ├── Assertions                                          │  │
│  │      └── Generators                                          │  │
│  │                                                               │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    TEST EXECUTION FLOW                        │  │
│  │                                                               │  │
│  │  1. Developer writes code                                    │  │
│  │           │                                                  │  │
│  │           ▼                                                  │  │
│  │  2. Run: make test-fast                                      │  │
│  │           │                                                  │  │
│  │           ▼                                                  │  │
│  │  3. Unit tests execute (mocked)                              │  │
│  │           │                                                  │  │
│  │           ▼                                                  │  │
│  │  4. Integration tests execute                                │  │
│  │           │                                                  │  │
│  │           ▼                                                  │  │
│  │  5. Coverage report generated                                │  │
│  │           │                                                  │  │
│  │           ▼                                                  │  │
│  │  6. Commit & Push                                            │  │
│  │           │                                                  │  │
│  │           ▼                                                  │  │
│  │  7. GitHub Actions CI/CD                                     │  │
│  │           │                                                  │  │
│  │           ▼                                                  │  │
│  │  8. All tests + Linting                                      │  │
│  │           │                                                  │  │
│  │           ▼                                                  │  │
│  │  9. ✅ Success → Merge                                       │  │
│  │                                                               │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│                    ASSET TESTING FLOW                               │
└─────────────────────────────────────────────────────────────────────┘

┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│  EXTRACTION  │  ────►  │TRANSFORMATION│  ────►  │   LOADING    │
│    TESTS     │         │    TESTS     │         │    TESTS     │
└──────────────┘         └──────────────┘         └──────────────┘
       │                        │                         │
       │                        │                         │
       ▼                        ▼                         ▼
┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│• File fetch  │         │• Column norm │         │• GDrive upload│
│• Encoding    │         │• Data clean  │         │• DB insert    │
│• Parsing     │         │• Type conv   │         │• Error handle │
│• Validation  │         │• Missing vals│         │• Verification │
└──────────────┘         └──────────────┘         └──────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│                    RESOURCE TESTING PATTERN                         │
└─────────────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────┐
│                  RESOURCE LIFECYCLE                       │
│                                                           │
│  1. Initialize ──► 2. Connect ──► 3. Execute ──► 4. Close│
│       │               │              │              │      │
│       ▼               ▼              ▼              ▼      │
│   [Test Init]    [Test Conn]   [Test Query]   [Test Close]│
│                                                           │
└───────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│                    MOCKING STRATEGY                                 │
└─────────────────────────────────────────────────────────────────────┘

  External Services          Mock Layer              Test Code
┌─────────────────┐      ┌─────────────┐      ┌─────────────────┐
│  Google Drive   │◄─────│ MockGDrive  │◄─────│  test_assets.py │
└─────────────────┘      └─────────────┘      └─────────────────┘
                                ▲
┌─────────────────┐      ┌─────────────┐             │
│  PostgreSQL     │◄─────│ MockPG      │◄────────────┤
└─────────────────┘      └─────────────┘             │
                                ▲                    │
┌─────────────────┐      ┌─────────────┐             │
│  MongoDB        │◄─────│ MockMongo   │◄────────────┤
└─────────────────┘      └─────────────┘             │
                                ▲                    │
┌─────────────────┐      ┌─────────────┐             │
│  DuckDB         │◄─────│ MockDuckDB  │◄────────────┘
└─────────────────┘      └─────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│                    CI/CD PIPELINE                                   │
└─────────────────────────────────────────────────────────────────────┘

  GitHub Push/PR
       │
       ▼
┌─────────────────┐
│  GitHub Actions │
│     Trigger     │
└────────┬────────┘
         │
    ┌────┴────┐
    │ Setup   │
    │ - Python│
    │ - Deps  │
    │ - DBs   │
    └────┬────┘
         │
    ┌────┴────┐
    │  Lint   │
    │ - black │
    │ - flake8│
    └────┬────┘
         │
    ┌────┴────┐
    │  Test   │
    │ - Unit  │
    │ - Integ │
    └────┬────┘
         │
    ┌────┴────┐
    │Coverage │
    │ Report  │
    └────┬────┘
         │
    ┌────┴────┐
    │ Upload  │
    │Artifacts│
    └────┬────┘
         │
         ▼
    ✅ Success
    or
    ❌ Failure


┌─────────────────────────────────────────────────────────────────────┐
│                    TEST FIXTURES HIERARCHY                          │
└─────────────────────────────────────────────────────────────────────┘

                    conftest.py
                         │
        ┌────────────────┼────────────────┐
        │                │                │
        ▼                ▼                ▼
   Data Fixtures    Resource Mocks   Context Builders
        │                │                │
   ┌────┴────┐      ┌────┴────┐      ┌────┴────┐
   │ • CSV   │      │ • GDrive│      │ • Basic │
   │ • DF    │      │ • DuckDB│      │ • w/Res │
   │ • Files │      │ • PG    │      │ • Custom│
   └─────────┘      │ • Mongo │      └─────────┘
                    └─────────┘


┌─────────────────────────────────────────────────────────────────────┐
│                    COVERAGE TRACKING                                │
└─────────────────────────────────────────────────────────────────────┘

  Code Module          Coverage Goal         Current Status
┌─────────────┐        ┌─────────┐          ┌──────────┐
│   Assets    │  ───►  │  85%+   │  ───►    │ [Track]  │
└─────────────┘        └─────────┘          └──────────┘
┌─────────────┐        ┌─────────┐          ┌──────────┐
│  Resources  │  ───►  │  90%+   │  ───►    │ [Track]  │
└─────────────┘        └─────────┘          └──────────┘
┌─────────────┐        ┌─────────┐          ┌──────────┐
│   Sensors   │  ───►  │  85%+   │  ───►    │ [Track]  │
└─────────────┘        └─────────┘          └──────────┘
┌─────────────┐        ┌─────────┐          ┌──────────┐
│   Overall   │  ───►  │  80%+   │  ───►    │ [Track]  │
└─────────────┘        └─────────┘          └──────────┘
